---
title: "ClimateWNA data manipulation"
author: "Tom Miller"
date: "September 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,message=F,warning=F)
library(tidyverse)
library(data.table)
library(chron)
library(ggfortify)
```

## Overview
I am trying to wrap up the climate analysis, which has become a real shitshow. There was just (9/5/2018) an email alert that ClimateWNA now includes 2017, which will allow us to add the 2016-17 transition year. So it is a good point to re-assess the climate data and how we interpret the PCs. I will run all of Kevin's PCA code here and recreate the seasonal PCA with the updated data, just so that I have a clear understanding of what Kevin did and how to interpret it. Lastly, I am dropping future climate change projections because I am uncomfortable (for now) projecting into very different future climates. The past is hard enough! _Update: In this branch, I am actually including the RCP projections! Modifications below._

## Tidy up ClimateWNA data
First, read in the historical data from ClimateWNA for the period 1901-2016. This comes from the lat, long, and elevation of the Blue Grama met station (34.335, -106.632, 1669). I can (need to) show elsewhere that ClimateWNA data correlate well with SEV met data. Better to do this with Deep Well, which is the longest SEV met data set. I will do this elsewhere or below. The steps below compute seasonal values (sums or averages) from the raw monthly data, where warm season is May through September and cool season is October through April.
```{r climate dat manip}
#SEV_clim <- read.csv("ClimWNA_SEV_1901-2017AMT.csv")
# Now working with RCP projections.
SEV_clim_historical <- read.csv("./ClimWNA_data/ClimWNA_SEV_1901-2017AMT.csv")%>% 
  filter(ID2 == "BlueGrama")

SEV_clim_ACCESS_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_ACCESS1-0_RCP45.csv") %>% mutate(model = "access", RCP = 45)
SEV_clim_ACCESS_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_ACCESS1-0_RCP85.csv") %>% mutate(model = "access", RCP = 85)
SEV_clim_CanESM2_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CanESM2_RCP45_r11i1p1.csv") %>% mutate(model = "canesm2", RCP = 45)
SEV_clim_CanESM2_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CanESM2_RCP85_r11i1p1.csv") %>% mutate(model = "canesm2", RCP = 85)
SEV_clim_CCSM4_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CCSM4_RCP45.csv") %>% mutate(model = "ccsm4", RCP = 45)
SEV_clim_CCSM4_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CCSM4_RCP85.csv") %>% mutate(model = "ccsm4", RCP = 85)
SEV_clim_CNRM_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CNRM-CM5_RCP45.csv") %>% mutate(model = "cnrm", RCP = 45)
SEV_clim_CNRM_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CNRM-CM5_RCP85.csv") %>% mutate(model = "cnrm", RCP = 85)
SEV_clim_CSIRO_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CSIRO-Mk3-6-0_RCP45_r11i1p1.csv") %>% mutate(model = "csiro", RCP = 45)
SEV_clim_CSIRO_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_CSIRO-Mk3-6-0_RCP85_r11i1p1.csv")%>% mutate(model = "csiro", RCP = 85)
SEV_clim_INM_45 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_INM-CM4_RCP45.csv")%>% mutate(model = "inm", RCP = 45)
SEV_clim_INM_85 <- read.csv("./ClimWNA_data/ClimWNA_SEV_input_INM-CM4_RCP85.csv")%>% mutate(model = "inm", RCP = 85)

## bind projections together and average over 6 GCM models
SEV_clim_future <- bind_rows(SEV_clim_ACCESS_45,SEV_clim_ACCESS_85,
                             SEV_clim_CanESM2_45,SEV_clim_CanESM2_85,
                             SEV_clim_CCSM4_45,SEV_clim_CCSM4_85,
                             SEV_clim_CNRM_45,SEV_clim_CNRM_85,
                             SEV_clim_CSIRO_45,SEV_clim_CSIRO_85,
                             SEV_clim_INM_45,SEV_clim_INM_85) %>% 
  filter(ID2 == "BlueGrama") %>% 
  group_by(RCP,Year) %>% 
  summarise(Tmax01 = mean(Tmax01),
            Tmax02 = mean(Tmax02),
            Tmax03 = mean(Tmax03),
            Tmax04 = mean(Tmax04),
            Tmax05 = mean(Tmax05),
            Tmax06 = mean(Tmax06),
            Tmax07 = mean(Tmax07),
            Tmax08 = mean(Tmax08),
            Tmax09 = mean(Tmax09),
            Tmax10 = mean(Tmax10),
            Tmax11 = mean(Tmax11),
            Tmax12 = mean(Tmax12),
            
            Tave01 = mean(Tave01),
            Tave02 = mean(Tave02),
            Tave03 = mean(Tave03),
            Tave04 = mean(Tave04),
            Tave05 = mean(Tave05),
            Tave06 = mean(Tave06),
            Tave07 = mean(Tave07),
            Tave08 = mean(Tave08),
            Tave09 = mean(Tave09),
            Tave10 = mean(Tave10),
            Tave11 = mean(Tave11),
            Tave12 = mean(Tave12),
            
            Tmin01 = mean(Tmin01),
            Tmin02 = mean(Tmin02),
            Tmin03 = mean(Tmin03),
            Tmin04 = mean(Tmin04),
            Tmin05 = mean(Tmin05),
            Tmin06 = mean(Tmin06),
            Tmin07 = mean(Tmin07),
            Tmin08 = mean(Tmin08),
            Tmin09 = mean(Tmin09),
            Tmin10 = mean(Tmin10),
            Tmin11 = mean(Tmin11),
            Tmin12 = mean(Tmin12),
            
            PPT01 = mean(PPT01),
            PPT02 = mean(PPT02),
            PPT03 = mean(PPT03),
            PPT04 = mean(PPT04),
            PPT05 = mean(PPT05),
            PPT06 = mean(PPT06),
            PPT07 = mean(PPT07),
            PPT08 = mean(PPT08),
            PPT09 = mean(PPT09),
            PPT10 = mean(PPT10),
            PPT11 = mean(PPT11),
            PPT12 = mean(PPT12))

SEV_clim_future_45 <- SEV_clim_future %>% 
  filter(RCP==45)
SEV_clim_future_85 <- SEV_clim_future %>% 
  filter(RCP==85)

## gather each climate variable into its own df and derive month

Tmax_historical <- SEV_clim_historical %>% 
  select(Year,Tmax01:Tmax12) %>% 
  gather(Tmax01:Tmax12,key="Month",value="Tmax")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tmax_future_45 <- SEV_clim_future_45 %>% 
  select(Year,Tmax01:Tmax12) %>% 
  gather(Tmax01:Tmax12,key="Month",value="Tmax")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tmax_future_85 <- SEV_clim_future_85 %>% 
  select(Year,Tmax01:Tmax12) %>% 
  gather(Tmax01:Tmax12,key="Month",value="Tmax")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 

Tmin_historical <- SEV_clim_historical %>% 
  select(Year,Tmin01:Tmin12) %>% 
  gather(Tmin01:Tmin12,key="Month",value="Tmin")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tmin_future_45 <- SEV_clim_future_45 %>% 
  select(Year,Tmin01:Tmin12) %>% 
  gather(Tmin01:Tmin12,key="Month",value="Tmin")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tmin_future_85 <- SEV_clim_future_85 %>% 
  select(Year,Tmin01:Tmin12) %>% 
  gather(Tmin01:Tmin12,key="Month",value="Tmin")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 

Tave_historical <- SEV_clim_historical %>% 
  select(Year,Tave01:Tave12) %>% 
  gather(Tave01:Tave12,key="Month",value="Tave")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tave_future_45 <- SEV_clim_future_45 %>% 
  select(Year,Tave01:Tave12) %>% 
  gather(Tave01:Tave12,key="Month",value="Tave")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 
Tave_future_85 <- SEV_clim_future_85 %>% 
  select(Year,Tave01:Tave12) %>% 
  gather(Tave01:Tave12,key="Month",value="Tave")%>% 
  mutate(Month = as.integer(str_sub(Month,5,6))) 

PPT_historical <- SEV_clim_historical %>% 
  select(Year,PPT01:PPT12) %>% 
  gather(PPT01:PPT12,key="Month",value="PPT")%>% 
  mutate(Month = as.integer(str_sub(Month,4,5))) 
PPT_future_45 <- SEV_clim_future_45 %>% 
  select(Year,PPT01:PPT12) %>% 
  gather(PPT01:PPT12,key="Month",value="PPT")%>% 
  mutate(Month = as.integer(str_sub(Month,4,5))) 
PPT_future_85 <- SEV_clim_future_85 %>% 
  select(Year,PPT01:PPT12) %>% 
  gather(PPT01:PPT12,key="Month",value="PPT")%>% 
  mutate(Month = as.integer(str_sub(Month,4,5))) 

## merge variables into single df's
historical_clim <- left_join(left_join(left_join(Tmax_historical,Tmin_historical,by=c("Year","Month")),
                            Tave_historical,by=c("Year","Month")),
                            PPT_historical,by=c("Year","Month"))
future_45_clim <- left_join(left_join(left_join(Tmax_future_45,Tmin_future_45,by=c("RCP","Year","Month")),
                            Tave_future_45,by=c("RCP","Year","Month")),
                            PPT_future_45,by=c("RCP","Year","Month")) 
future_85_clim <- left_join(left_join(left_join(Tmax_future_85,Tmin_future_85,by=c("RCP","Year","Month")),
                            Tave_future_85,by=c("RCP","Year","Month")),
                            PPT_future_85,by=c("RCP","Year","Month"))

## bind the 3 data types and assign transition year and season
#
SEV_clim_final <- bind_rows(historical_clim,future_45_clim,future_85_clim) %>% 
  mutate(trans_year = ifelse(Month >=5, Year, Year-1),
         season = ifelse(Month >=5 & Month <=9,"warm","cool")) %>% 
  arrange(RCP,Year,Month)%>% 
  group_by(RCP,trans_year,season) %>% 
  summarise(max_temp = max(Tmax),
            min_temp = min(Tmin),
            mean_temp = round(mean(Tave),digits=1),
            tot_prcp = sum(PPT)) %>% 
  filter(trans_year>=1901) %>% 
  mutate(demographic_data = ifelse(trans_year>=2004 & trans_year<2017,T,F))
  
SEV_clim_final %>% filter(season=="cool") %>% 
ggplot()+
  geom_point(aes(x=trans_year,y=min_temp,color=demographic_data))

```

Something weird is happening in 2017, which bridges 'past' and 'future'.
```{r weirdness}
SEV_clim_final %>% filter(trans_year==2016)
SEV_clim_final %>% filter(trans_year==2017)
SEV_clim_final %>% filter(trans_year==2018)
```
It appears that the 2017-18 transition year is getting two cool seasons: one from the real data (Oct-Dec 2017) and one from the projected data (Jan-May 2018). This is super annoying. I think the easiest solution is to remove the 2017-18 transition year altogether.
```{r drop 2017}
dim(SEV_clim_final)
SEV_clim_final <- SEV_clim_final %>% 
  filter(trans_year!=2017)
```


## Principal Components Analysis
I first need to spread the seasonal values, then I can run the PCA.
```{r PCA}
A<-SEV_clim_final %>% 
  select(trans_year,season,min_temp) %>% 
  spread(key=season,value=min_temp) %>% 
  set_names(c("RCP","trans_year","min_temp_cool","min_temp_warm"))
B<-SEV_clim_final %>% 
  select(trans_year,season,mean_temp) %>% 
  spread(key=season,value=mean_temp) %>% 
  set_names(c("RCP","trans_year","mean_temp_cool","mean_temp_warm"))
C<-SEV_clim_final %>% 
  select(trans_year,season,max_temp) %>% 
  spread(key=season,value=max_temp) %>% 
  set_names(c("RCP","trans_year","max_temp_cool","max_temp_warm"))
D<-SEV_clim_final %>% 
  select(trans_year,season,tot_prcp) %>% 
  spread(key=season,value=tot_prcp) %>% 
  set_names(c("RCP","trans_year","tot_prcp_cool","tot_prcp_warm"))

PCA_dat <- left_join(left_join(left_join(A,B),C),D) 
SEV_PCA <- prcomp(PCA_dat[,3:10],center = TRUE, scale. = TRUE)
## find the weight of each climate variable in the PCs
SEV_PCA$rotation
summary(SEV_PCA)
autoplot(SEV_PCA,loadings=T,loadings.label=T)
```

Lastly, write the PCA values to file, to be used in demographic analysis.
```{r write PCA}
out<-data.frame(cbind(PCA_dat$trans_year,SEV_PCA$x))
names(out)[1]<-"Year_t"
#do this only once
#write.csv(out,"climateWNA_PCvalues_out.csv")
#write.csv(data.frame(SEV_PCA$rotation),"climateWNA_PCrotation_out.csv")
```

```{r}
PC_gather <- as_tibble(cbind(PCA_dat$trans_year,SEV_PCA$x))
names(PC_gather)[1] <- "Year_t"
PC_gather <- PC_gather%>% 
  select(-PC4,-PC5,-PC6,-PC7,-PC8) %>% 
  gather(PC1,PC2,PC3,key="PC",value="value") %>% 
  mutate(time = ifelse(Year_t<2004,"past",ifelse(Year_t>2016,"future","present")))

PC_range <- PC_gather %>% 
  group_by(PC) %>% 
  summarise(PC_min = min(value),
            PC_max = max(value))
x_PC1 = seq(PC_range$PC_min[PC_range$PC=="PC1"],PC_range$PC_max[PC_range$PC=="PC1"],0.1)
x_PC2 = seq(PC_range$PC_min[PC_range$PC=="PC2"],PC_range$PC_max[PC_range$PC=="PC2"],0.1)
x_PC3 = seq(PC_range$PC_min[PC_range$PC=="PC3"],PC_range$PC_max[PC_range$PC=="PC3"],0.1)

ggplot(PC_gather)+
  geom_histogram(aes(x=value,fill=time))+
    facet_grid(PC~.)

ggplot(PC_gather)+
  geom_line(aes(x=Year_t,y=value,color=time))+
    facet_grid(PC~.)
```

